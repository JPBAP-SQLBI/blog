---
title: オンプレミスとクラウドデータソースのマージ・アペンド時に必要な設定について
date: 2025-05-30 00:00:00 
tags:
  - Power BI
  - Microsoft Fabric
  - Power BI サービス
  - オンプレミスデータゲートウェイ
  - On premises data gateway
  - VNet データ ゲートウェイ
  - Virtual network data gateway
  - マージ
  - アペンド

---

こんにちは、Power BI サポート チームの中川です。

Power BI では、さまざまなデータソースに接続し、それらを組み合わせてレポートやダッシュボードを作成できます。しかし、オンプレミス データソース と クラウド データソースのように異なるデータソースをマージまたはアペンドする場合には、必要な設定があることをご存じでしょうか。

本ブログでは、「オンプレミスとクラウドデータソースのマージ・アペンド時に必要な設定について」ご紹介します。


<!-- more -->
> [!IMPORTANT]  
> 本記事は弊社公式ドキュメントの公開情報を元に構成しておりますが、
> 本記事編集時点と実際の機能に相違がある場合がございます。  
> 最新情報につきましては、参考情報として記載しておりますドキュメントをご確認ください。

---
## 目次
---
* [ゲートウェイの動作](#ゲートウェイの動作)
* [ゲートウェイごとに必要な設定](#ゲートウェイごとに必要な設定)

* [おわりに](#おわりに)


---
## ゲートウェイの動作
---
セマンティック モデルが、異なる種類のクエリを使用して オンプレミス データソース と クラウド データソース の両方に接続している場合、 Power BI はそれぞれ以下のように接続します。（接続イメージは図を参照）
•	オンプレミス データソース：ゲートウェイ経由で接続
•	クラウド データソース：Power BI から接続

（※以下の図はオンプレミス データ ゲートウェイの例ですが、 VNet データ ゲートウェイでも基本的な挙動は同様です。）
<div align="left">
<img src="Individual_Query_Without_Merge_or_Append.png">
</div>

</br>

ただし、1つのクエリ内でこれら 2 つのデータソースをマージまたはアペンドする場合、以下図のようにクラウド データソースにもゲートウェイを経由して接続しようとする挙動に変わります。
</br>

>[!NOTE]
> 参考情報：[Power BI でのデータの更新 - Power BI | Microsoft Learn](https://learn.microsoft.com/ja-jp/power-bi/connect-data/refresh-data#accessing-on-premises-and-cloud-sources-in-the-same-source-query)

<div align="left">
<img src="Document_Details.png">
</div>
</br>


<div align="left">
<img src="Individual_Query_With_Merge_or_Append.png">
</div>
</br>


例えば以下のような構成が該当します。
- ファクトテーブル：Azure SQL Database（ゲートウェイ経由）
- ディメンションテーブル：SharePoint Online 上の Excel（ゲートウェイなし）
- 上記を Power Query でマージまたはアペンド


このような構成でゲートウェイやクラウド接続の設定が正しく行われていないと、セマンティックモデルの更新（リフレッシュ）時に以下のようなエラーが発生します。



``` json
データ ソース エラー{"error":{"code":"Premium_ASWL_Error","pbi.error":{"code":"Premium_ASWL_Error","parameters":{},"details":[{"code":"Premium_ASWL_Error_Details_Label","detail":{"type":1,"value":"Cloud data source setting is not allowed refresh through gateway."}}],"exceptionCulprit":1}}} Table: マージ1.

機械翻訳：クラウド データソースの設定がゲートウェイ経由でのリフレッシュを許可していません。
```


このエラーは、クラウド データソースへのゲートウェイ経由の接続が許可されていないことを示しており、このようなエラーを回避するには、ゲートウェイとクラウド接続の正しい設定が必要です。


また、Power BI のクラウド データソースには、接続方法が以下の2種類があり、利用する接続方法によって必要な設定が異なります。
- 個人用クラウド接続：Power BI ユーザーが個別に設定する接続。
- 共有クラウド接続　：複数ユーザーで共有される接続。

なお、個人用クラウド接続と共有クラウド接続は、セマンティック モデルの設定から、[ゲートウェイとクラウド接続]の[クラウド接続]にて確認が可能です。


<div align="left">
<img src="Personal_Cloud_Connection_Shared_Cloud_Connection.png">
</div>
</br>

>[!NOTE]
> 参考情報：[Power BI サービスでクラウド データ ソースに接続する - Power BI | Microsoft Learn](https://learn.microsoft.com/ja-jp/power-bi/connect-data/service-connect-cloud-data-sources)


次章からは、ゲートウェイごとに必要な設定方法をご紹介していきます。


---
## ゲートウェイごとに必要な設定
---
先述の通り、オンプレミスとクラウドのデータソースをマージ・アペンドする際、利用するゲートウェイやクラウド接続のタイプによって必要な設定が異なります。
下表は、どの場合にどの設定が必要かをまとめたものです。


| オンプレミス(ゲートウェイ) データ ソース | クラウドデータソース        | 必要な設定      |
|----------------------------------------|-----------------------------|-----------------|
| オンプレミス データ ゲートウェイ       | 個人用クラウド接続          | ①              |
| オンプレミス データ ゲートウェイ       | 共有クラウド接続            | ① + ②          |
| VNet データ ゲートウェイ               | 個人用クラウド接続          | 不要            |
| VNet データ ゲートウェイ               | 共有クラウド接続            | ②              |


以下に必要な設定について、それぞれの手順をご説明します。

### ① ゲートウェイ設定で「ユーザーのクラウド データソースが、このゲートウェイ クラスターを介して更新することを許可」を有効にする
前の章でご紹介した通り、オンプレミスとクラウドのデータソースをマージまたはアペンドする場合、クラウド データソースにもオンプレミス ゲートウェイ経由でアクセスが必要になるため、以下の設定を行います。

//設定手順
1. [Power BI サービス] > 右上の設定（歯車アイコン） > [接続とゲートウェイの管理] > [オンプレミスデータゲートウェイ] を選択します。
2. 構成するゲートウェイを選択し、三点リーダー（・・・）から [設定] を選択します。
3. [設定] で [ユーザーのクラウド データソースが、このゲートウェイ クラスターを介して更新することを許可します。] > [保存] の順に選びます。
 

<div align="left">
<img src="Allow_OPGW_users_to_refresh_cloud_data_sources_through_this_gateway_cluster.png">
</div>
</br>

>[!NOTE]
> 参考情報：[オンプレミスとクラウド データソースのマージまたはアペンド - Power BI | Microsoft Learn](https://learn.microsoft.com/ja-jp/power-bi/connect-data/service-gateway-mashup-on-premises-cloud)


### ② 共有クラウド接続の設定で「オンプレミスのデータ ゲートウェイまたは VNet データ ゲートウェイでこの接続を使用できるようにします。」を有効にする

// 設定手順
1. [Power BI サービス] > 右上の設定（歯車アイコン） > [接続とゲートウェイの管理] > [接続] を選択します。
2. 構成する 接続名 を選択し、三点リーダー（・・・）から [設定] を選択します。
3. [設定] で [オンプレミスのデータ ゲートウェイまたは VNet データ ゲートウェイでこの接続を使用できるようにします。] > [保存] の順に選びます。

<div align="left">
<img src="Enable_this_shared_cloud_connection_for_use_with_on-premises_data_gateway_or_VNet_data_gateway.png">
</div>
</br>

なお、VNet データ ゲートウェイでは、オンプレミス ゲートウェイのようなクラウド接続を個別に許可する設定項目は存在しません。そのため、個人用クラウド接続の場合は特別な設定は不要です。



---
## おわりに
本ブログでは、オンプレミスとクラウドのデータソースをマージまたはアペンドする場合に必要なゲートウェイ設定についてご紹介しました。

本シナリオの該当する構成のセマンティックモデルがある場合は、ご紹介した設定をご確認いただくことをおすすめします。

以上、本ブログが少しでも皆様のお役に立てますと幸いでございます。



---

**アンケートご協力のお願い**
Japan CSS Support Power BI Blog では、作成する記事やブログの品質向上を目的に、匿名回答でのアンケートを実施しております。
ユーザー様のご意見・ご要望を参考に今後もお役に立てるブログを目指してまいりますので、ぜひご協力いただけますと幸いでございます。 

※　所要時間は1分程度となります。
[【ご協力のお願い】Microsoft Japan CSS Power BI Blog ご利用に関するアンケート](https://jpbap-sqlbi.github.io/blog/powerbi/pbi_blogsurvey2022/)