---
title: Power BI の行レベルのセキュリティー (RLS)
date: 2023-10-31 15:00:00
tags:
  - Power BI
  - データモデル
  - 行レベルのセキュリティー
  - RLS
  - ユーザーごと表示されるデータの制御
  - Row Level Security
  - ロール管理
---

こんにちは、Power BI サポート チームのチャンです。 

Power BI でレポートを共有するにあたり、同じレポートで閲覧する場合でも、ユーザーごとで閲覧可能なデータの範囲を設定したい業務要件がよく見られます。今回はユーザーごとで表示されるデータの制御を実施できる Power BI の行レベルのセキュリティーという機能を詳しく案内していきます。

<!-- more -->

> [!IMPORTANT]
> 本記事は弊社公式ドキュメントの公開情報を元に構成しておりますが、
> 本記事編集時点と実際の機能に相違がある場合がございます。
> 最新情報につきましては、参考情報として記載しておりますドキュメントをご確認ください。

---
## 目次
---
1. [前提条件](#前提条件)
2. [使用例](#使用例)
3. [考慮事項と制限事項](#考慮事項と制限事項)

---
## 前提条件
---

行レベルのセキュリティー (RLS: Row-level Security) は、すべての権限のユーザーに対して適用する機能ではございません。ワークスペースに対して、コンテンツの作成、編集、削除ができない権限を有しているユーザーにのみ適用可能です。
また、RLSが適用されないユーザーは、セキュリティフィルターが適用されず、すべてのデータ行が見られます。

#### 〇 RLS が適用されるユーザーの権限
- ワークスペースのビューアー
- レポートの読み取り
- 組織アプリの読み取り

#### × RLS が適用されないユーザーの権限
- ワークスペースの管理者
- ワークスペースのメンバー
- ワークスペースの共同作成者

もしユーザーが同時に RLS が適用されない権限（例：ワークスペースのメンバー）のグループと、 RLS が適用される権限（例：ワークスペースのビューアー）のグループに所属している場合、上位の権限であるメンバーが適用されるため、 RLS によって閲覧可能なデータ範囲の制御は機能しません。

#### ■ 上位から下位のワークスペース権限

管理者 > メンバー > 共同作成者 > ビューアー

> **参考情報**
> [Power BI での行レベルのセキュリティ (RLS) - Power BI | Microsoft Learn](https://learn.microsoft.com/ja-jp/power-bi/enterprise/service-admin-rls)

---
## 使用例
---

行レベルセキュリティー (RLS) は、主にデータのフィルター条件を直接に記載するシンプルな方法と、ユーザーのユーザープリンシパル名 (UPN) を検知してデータテーブルのリレーションシップによって動的に制御する方法がございます。

以下にてそれぞれ使用例をご紹介いたします。

- [前提条件](#■-前提条件)
- [使用例①：静的なフィルター](#■-使用例①：フィルター条件を直接に記載する方法)
- [使用例②：動的なフィルター](#■-使用例②：ユーザーのユーザープリンシパル名を検知してデータテーブルのリレーションシップによって動的に制御する方法)


### ■ 前提条件
二つの例ともに、ユーザーのアクセス権限の追加手順を省略していますが、レポートを発行したワークスペースに対して、事前に対象のRLS適用ユーザーを「ビューアー」として追加していることを前提としています。

> **参考情報**
> [Power BI サービスでのコンテンツ共有方法の種類](../pbi_contents_share_1/)

### ■ 使用例①：フィルター条件を直接に記載する方法

フィルター条件を直接に記載する方法の手順についてご紹介いたします。

1. Power BI Desktop でレポートを開き、[モデリング] > [ロールの管理] の順で選択すると、ロールの管理のウィザードが表示されます。
[新規] をクリックし、ロールの名前を入力いただき、フィルター条件をかけたいテーブルを選択し、フィルター条件の設定を実施します。
以下の例では、Country が「 Canada 」のデータのみを閲覧できるように、RLS のロールを作成します。
<div align="center">
<img src="role_filter.png">
</div>

2. [DAX エディターに切り替えるボタン] をクリックいただくと、直接 DAX のフィルター条件を記載いただくことも可能です。
<div align="center">
<img src="role_filter_dax.png">
</div>

3. 保存すれば、これで Power BI Desktop での設定は完了ですが、こちらの設定で正しくフィルターかけているかを確認するために、[モデリング] > [表示方法] を選択し、先ほど作成したロールを選択して、[OK] で確定させれば、そのロールで表示した場合の画面をご確認いただけます。
<div align="center">
<img src="test_result_country_canada.png">
</div>

4. 問題なく設定できていることを確認できたら、レポートを Power BI サービスへ発行します。
5. 発行後に、こちらのロールを適用したいユーザーを追加する必要があるため、データセットに対して […] > [セキュリティ]を選択します。
<div align="center">
<img src="dataset_security.png">
</div>

6. 次の画面で、適用したいユーザーを追加します。
<div align="center">
<img src="dataset_security_user.png">
</div>

7. 追加後に、ロールに対して[…] > [ロールとしてテスト] を実施し、想定通りの表示ができるかテストします。
<div align="center">
<img src="dataset_security_roletest.png">
</div>

8. [次のユーザーとして表示] を選択すると、特定のユーザーの観点でどうデータが見られるかのテストが可能です。
以下 User01 の例では、想定通りのフィルターがかかった状態のレポートが表示されることを確認できました。
<div align="center">
<img src="dataset_security_roletest_user01.png">
</div>
<br>
また、セキュリティのロールに追加されていない User02 の例では、適切なロールが適用されないため、ビジュアルの部分にエラーが表示されます。
<br>
<div align="center">
<img src="dataset_security_roletest_user02.png">
</div>

> [!TIP]
> 本記事では、Power BI Desktop で RLS ロールを作成する方法を紹介していますが、現在 Power BI サービスでRLS ロールを作成する、及びセキュリティで対象のユーザーを割り当てることができるようになっていますので、詳細に関しては以下のブログ記事をご参考ください。
> [Power BI サービスでデータモデルを編集する](../pbi_modify_model_in_service/)

### ■ 使用例②：ユーザーのユーザープリンシパル名を検知してデータテーブルのリレーションシップによって動的に制御する方法

RLS の適用対象ユーザーが少ない場合には、各ユーザーに対して、適用するフィルターを Power BI 内のロール管理で実施いただけますが、大量なユーザーに対してそれぞれ異なるフィルター条件を設定する場合には、画面上の操作では相当な労力や時間がかかることが想定されます。

以下にて、その際の代替案をご案内します。こちらの方法では、事前にフィルター条件が含まれているデータテーブルを用意いただく必要がございますが、ユーザーのユーザープリンシパル名 (UPN) を検知して動的に閲覧可能なデータを制御できます。

1. 以下の例では、ユーザーが所属しているセグメントの情報を利用して、該当セグメントによって閲覧可能なデータを制御します。
実際の運用シナリオにおいて、セグメントを、各会社の部署、事業部などに置き換えて想像いただければと思います。
まず、以下のような3つのテーブルを用意します。

- <b>所属部署の一覧のマスターテーブル</b>
例：Segmentテーブル
<br>
<div align="center">
<img src="table_segment.png">
</div>
 
- <b>所属部署とユーザープリンシパル名が紐づいたマスターテーブル</b>
例：UPN_Segmentテーブル
<br>
<div align="center">
<img src="table_segment_upn.png">
</div>
 
- <b>売上情報といったファクトテーブル</b>
例：Salesテーブル
<br>
<div align="center">
<img src="table_sales.png">
</div>
 
2. Power BI のレポートにインポートし、以下画像のようにリレーションシップを設定します。
•	Segmentテーブルから、Salesテーブルに対して、1対多の単一方向のリレーションシップ
•	UPN_Segmentテーブルから、Segmentテーブルに対して、1対多の双方向リレーションシップ、かつ両方向にセキュリティーフィルターを適用する
<br>
<div align="center">
<img src="rls_relationships.png">
</div>
<br>

3. [モデリング] > [ロールの管理] にて、新規のロールを作成し、UPN情報が入っているテーブルで、[DAX エディターに切り替えるボタン] をクリックいただき、以下の関数を入力します。
※ [UPN] は列名なので、適宜UPN情報の列名を置き換えてください。

```
[UPN] = USERPRINCIPALNAME()
```
<br>
<div align="center">
<img src="role_upn.png">
</div>
 
 
4. ここまで設定した内容を保存すれば、これで Power BI Desktop での設定は完了ですが、こちらの設定で正しくフィルターかけているかを確認するために、[モデリング] > [表示方法] を選択し、先ほど作成したロールを選択した上で、[その他のユーザー] にてテストしたいユーザープリンシパル名を入力し、[OK] で確定させれば、そのロールとユーザー名で表示した場合の画面をご確認いただけます。
<br><div align="center">
<img src="test_result_segment_role.png">
</div>

5. 問題なく設定できていることを確認できたら、レポートを Power BI サービスへ発行します。

6. 発行後に、こちらのロールを適用したいユーザーを追加する必要があるため、データセットに対して […] > [セキュリティ]を選択します。
<div align="center">
<img src="dataset_security.png">
</div>

7. 次の画面で、適用したいユーザーやユーザーをメンバーとして追加したセキュリティグループを追加します。
<div align="center">
<img src="dataset_security_usergroup.png">
</div>

> **参考情報**
> [Microsoft 365 管理センターでセキュリティ グループを作成、編集、削除する | Microsoft Learn](https://learn.microsoft.com/ja-jp/microsoft-365/admin/email/create-edit-or-delete-a-security-group?view=o365-worldwide)
 
8. 追加後に、ロールに対して[…] > [ロールとしてテスト] を実施し、想定通りの表示ができるかテストします。
<div align="center">
<img src="dataset_security_roletest2.png">
</div>

9. [次のユーザーとして表示] を選択すると、特定のユーザーの観点でどうデータが見られるかのテストが可能です。
以下 User01 の例では、想定通りのフィルターがかかった状態のレポートが表示されることを確認できました。
<div align="center">
<img src="dataset_security_roletest_user01_2.png">
</div>

> [!TIP]
> 本記事では、Power BI Desktop で RLS ロールを作成する方法を紹介していますが、現在 Power BI サービスでRLS ロールを作成する、及びセキュリティで対象のユーザーを割り当てることができるようになっていますので、詳細に関しては以下のブログ記事をご参考ください。
> [Power BI サービスでデータモデルを編集する](../pbi_modify_model_in_service/)

---
## 注意点
---

#### ゲストユーザーに対する RLS

ゲストユーザーに対しても、RLSを適用することが可能ですが、Microsoft Entra（旧 Azure Active Directory）上では、ゲストユーザーのユーザープリンシパル名 (UPN) に #EXT# 識別子が含まれています。

> **参考情報**
> [Microsoft Entra B2B コラボレーション ユーザーのプロパティ | Microsoft Learn](https://learn.microsoft.com/ja-jp/entra/external-id/user-properties#key-properties-of-the-microsoft-entra-b2b-collaboration-user)

しかしながら、Power BI で USERPRINCIPALNAME() でユーザーの UPN を取得する場合は、Power BI サービスへサインインしているユーザー名を取得します。ユーザー名は、プロファイルアイコンをクリックして、ご確認いただけます。こちらのユーザー名は、ほとんどの場合は、 #EXT# 識別子を含まない本来のメールアドレスとなります。

<div align="center">
<img src="profile_icon_upn.png">
</div>

もし前セッションで紹介した[使用例②](#■-使用例②：ユーザーのユーザープリンシパル名を検知してデータテーブルのリレーションシップによって動的に制御する方法)の方を採用する場合、ユーザープリンシパル名 (UPN) はゲストユーザーが Power BI サービスへサインインする際のユーザー名に準じます。


> **参考情報**
> - [Power BI Desktop での行レベルのセキュリティ (RLS) のガイダンス | Microsoft Learn](https://learn.microsoft.com/ja-jp/power-bi/guidance/rls-guidance)
> - [Power BI での行レベルのセキュリティ (RLS) | Microsoft Learn](https://learn.microsoft.com/ja-jp/power-bi/enterprise/service-admin-rls)



以上、本ブログが少しでも皆様のお役に立てますと幸いでございます。 




